# Exporting Database Schema from Supabase

This guide explains how to export your Supabase database schema using `pg_dump`.

## The Problem

Supabase blocks direct database connections by default for security reasons. When you try to connect with `pg_dump` using port 5432, you may encounter:

```
pg_dump: error: connection to server at "...", port 5432 failed: No route to host
```

## Solutions

### Solution 1: IP Allowlisting (Recommended for pg_dump)

1. **Get your current IP address:**
   ```bash
   curl ifconfig.me
   ```

2. **Add IP to Supabase allowlist:**
   - Go to [Supabase Dashboard](https://supabase.com/dashboard)
   - Select your project
   - Navigate to **Settings** > **Database** > **Network Restrictions**
   - Click **Add new restriction**
   - Enter your IP address
   - Save and wait 1-2 minutes for changes to propagate

3. **Get the correct connection string:**
   - In Supabase Dashboard, go to **Settings** > **Database** > **Connection String**
   - Select **Session mode** (not Transaction mode)
   - Copy the connection string

4. **Export the schema:**
   ```bash
   pg_dump \
     --dbname "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres" \
     --schema-only \
     --no-owner \
     --no-privileges \
     > schema.sql
   ```

### Solution 2: Use Connection Pooler (Port 6543)

If IP allowlisting doesn't work, try using the connection pooler:

```bash
pg_dump \
  --dbname "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:6543/postgres" \
  --schema-only \
  --no-owner \
  --no-privileges \
  > schema.sql
```

**Note:** Change port from `5432` to `6543` to use Supavisor connection pooler.

### Solution 3: Use Supabase CLI (Easiest)

1. **Install Supabase CLI:**
   ```bash
   brew install supabase/tap/supabase
   ```

2. **Login and link your project:**
   ```bash
   supabase login
   supabase link --project-ref [YOUR_PROJECT_REF]
   ```

3. **Export schema:**
   ```bash
   supabase db dump -f schema.sql
   ```
   
   **Note:** Supabase CLI exports schema by default (no `--schema-only` flag needed). The `-f` flag specifies the output file.

### Solution 4: Use Helper Scripts

We provide two helper scripts:

**For pg_dump (requires IP allowlisting):**
```bash
./scripts/export-schema.sh "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres" schema.sql
```

**For Supabase CLI (recommended, handles auth automatically):**
```bash
./scripts/export-schema-supabase-cli.sh schema.sql [PROJECT_REF] [PASSWORD]
```

The Supabase CLI script will:
- Check if Supabase CLI is installed
- Handle login and project linking automatically
- Export schema without requiring IP allowlisting

### Solution 5: Export via Supabase Dashboard

If all else fails, you can manually export the schema:

1. Go to **SQL Editor** in Supabase Dashboard
2. Run queries to get schema information:
   ```sql
   -- Get all tables
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public';
   
   -- Get table definitions
   SELECT pg_get_tabledef('table_name');
   
   -- Get views
   SELECT view_definition 
   FROM information_schema.views 
   WHERE table_schema = 'public';
   ```

## Troubleshooting

### "No route to host" Error

- **Cause:** Your IP is not allowlisted or connection pooling is not enabled
- **Fix:** Add your IP to Network Restrictions in Supabase Dashboard

### "Connection refused" Error

- **Cause:** Wrong port or connection string format
- **Fix:** Verify you're using the correct connection string from Supabase Dashboard

### "Authentication failed" Error

- **Cause:** Incorrect password or username
- **Fix:** Double-check your database password in Supabase Dashboard

### Connection Pooler Issues

- **Cause:** Connection pooler may not support all `pg_dump` features
- **Fix:** Use IP allowlisting with direct connection (port 5432) or Supabase CLI

## Best Practices

1. **Use Supabase CLI** when possible - it handles authentication and connection automatically
2. **IP Allowlisting** - Add your IP only when needed, remove it when done
3. **Session Mode** - Always use Session mode connection strings for `pg_dump`
4. **Version Control** - Commit schema.sql to your repository to track schema changes

## Related Files

- `scripts/export-schema.sh` - Helper script for exporting schema
- `schema.sql` - Current database schema (generated by export)

